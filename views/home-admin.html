<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>管理员</title>
  <link rel="icon" href="./images/icon-tab.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="./css/style.css" />
  <style>
    /* Ensure the dropdown menu aligns properly and does not get cut off */
    .dropdown-menu {
      right: 0 !important; /* Align dropdown to the right edge */
      left: auto !important; /* Disable left alignment */
      width: 250px; /* Set the desired width */
      height: 240px;
    }

    .navbar {
      overflow: visible; /* Ensure dropdown is not clipped */
    }

    .dropdown-toggle::after {
      border-top-color: #cccccc !important;
    }

    .dropdown-menu {
      border-radius: 8px !important; /* Customize the border-radius */
    }

    .dropdown-menu {
      top: 43.5px !important; /* Lower position */
      right: 0.5px !important; /* Adjust horizontal position */
    }

    a.dropdown-item:focus {
      outline: none;
      box-shadow: 0 0 3px rgba(0, 0, 0, 0.3);
      background-color: rgba(180, 180, 180, 0.5); /* Light gray highlight */
      border-radius: 5px; /* Optional: Make the focus area rounded */
      transition: box-shadow 0.2s ease, background-color 0.2s ease;
    }

    .nav-tabs .nav-link {
      color: #555; /* Default text color for inactive tabs */
      background-color: #f8f9fa; /* Background color for inactive tabs */
      border-color: #ddd; /* Border color for inactive tabs */
    }

    .nav-tabs .nav-link:hover {
      color: #333; /* Text color on hover for inactive tabs */
      background-color: #e9ecef; /* Background color on hover */
    }

    /* #0d6efd */
    .nav-tabs .nav-link.active {
      color: #fff; /* Text color for active tab */
      background-color: #0a58ca; /* Background color for active tab */
      border-color: #0a58ca; /* Border color for active tab */
    }
  </style>
</head>

<body>
  <!-- Navigation bar -->
  <section id="nav-bar">
    <nav class="navbar navbar-expand-md navbar-dark bg-dark py-1" aria-label="Fourth navbar example">
      <div class="container-fluid pe-0">

        <a class="navbar-brand" href="#">精工 PAMS</a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsExample04" aria-controls="navbarsExample04" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarsExample04">
          <ul class="navbar-nav ms-auto mb-2 mb-md-0 me-3 pe-1" style="padding-left: 8px;">
            <li class="nav-item px-2 mx-1">
              <a class="nav-link active" aria-current="page" href="#homepage">首页</a>
            </li>
            <li class="nav-item mx-2">
              <a class="nav-link" href="#about">关于</a>
            </li>
            <li class="nav-item mx-1">
              <a class="nav-link" href="#projects" aria-disabled="false">查询</a>
            </li>
            <li class="nav-item pe-3 mx-2">
              <a class="nav-link" href="#contact">联系</a>
            </li>

            <li class="nav-item my-1">
              <div class="flex-shrink-0 dropdown">
                <a href="#" class="d-block link-body-emphasis text-decoration-none dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                  <img src="./images/admin.png" alt="pic" width="32" height="32" class="rounded-circle" style="border: 2px solid rgba(255, 255, 255, 0.2);">
                </a>

                <ul class="dropdown-menu dropdown-menu-start text-small shadow">
                  <li>
                    <a class="d-block link-body-emphasis text-decoration-none mt-4 mb-3" aria-expanded="false" style="text-align: center;">
                      <img src="./images/admin.png" alt="pic" width="70" height="70" class="rounded-circle" style="border: 2px solid rgba(0, 0, 0, 0.2);">
                    </a>
                  </li>
                  <li>
                    <p id="user-info" class="mb-3" style="text-align: center;">
                      <span id="user-username">正在加载用户信息..</span><br>
                      <span id="user-role"></span>
                    </p>
                  </li>
                  <li>
                    <hr class="dropdown-divider">
                  </li>
                  <li class="py-1 px-1"><a class="dropdown-item" href="/logout"><i class="bi bi-box-arrow-right pe-1 mb-0"></i> 退出登录</a></li>
                </ul>
              </div>
            </li>

          </ul>
        </div>
      </div>
    </nav>
  </section>

  <!-- Home page -->
  <section id="homepage">
    <div class="position-relative overflow-hidden p-3 p-md-5 mb-md-3 m-md-3 mb-3 mt-md-0 text-center bg-body-tertiary add">
      <div class="p-sm-4 p-lg-5 mx-auto mt-4 mb-3 mt-md-5 custom-align">
        <h4>欢迎使用</h4>
        <h1 class="display-3 fw-bold relative-pos">零件管理系统！</h1>
        <div class="custom-div">
          <p class="fw-normal text-muted mb-3 ps-1 pt-2">精工零件管理系统专注于为企业提供高效、精准的零件管理解决方案。通过我们的智能系统，您可以轻松追踪库存、优化采购流程，提高生产效率，有效提升供应链的整体运作水平。我们秉承“专注细节，成就卓越”的理念，不断创新技术，打造简单易用又功能强大的管理平台，帮助企业降低成本、提升竞争力，让您在快速变化的市场中始终占得先机。</p>
        </div>
      </div>
    </div>
  </section>

  <!-- About Me -->
  <section id="about">
    <div class="position-relative overflow-hidden px-3 px-md-5 m-md-3 mb-3 pt-lg-4 pb-lg-4 add">
      <div class="px-sm-4 px-lg-5 mx-auto mt-4 custom-align custom-last">
        <h2 class="display-6 link-body-emphasis mb-1">关于我们</h2>
        <p class="blog-post-meta mt-4 mb-2">公司简介</p>
        <p class="custom-pg">精工零件管理有限公司成立于2024年，总部位于海南。作为一家专注于零件管理的科技公司，我们结合先进的数据库技术和现代化的管理理念，为全球制造业提供全面的解决方案。
          我们的团队由行业资深专家、软件工程师和客户服务人员组成，致力于帮助客户减少运营成本、提升生产效率。</p>
      </div>
    </div>
  </section>

  <!-- Projects -->
  <section id="projects">
    <div class="position-relative overflow-hidden p-4 px-md-5 m-md-3 py-1 py-md-4 text-center bg-body-tertiary">
      <div class="container mt-5 mb-4">
  <h1 class="text-center mb-4">全部表册</h1>

  <!-- Tabs for switching between tables -->
  <ul class="nav nav-tabs mb-4" id="tableTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="warehouse-tab" data-bs-toggle="tab" data-bs-target="#warehouse" type="button" role="tab" aria-controls="warehouse" aria-selected="true">
        仓库信息表
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="suppliers-tab" data-bs-toggle="tab" data-bs-target="#supplier" type="button" role="tab" aria-controls="supplier" aria-selected="false">
        供应商信息表
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="parts-tab" data-bs-toggle="tab" data-bs-target="#parts" type="button" role="tab" aria-controls="parts" aria-selected="false">
        零件采购信息表
      </button>
    </li>
  </ul>

  <!-- Tab content -->
  <div class="tab-content" id="tableTabsContent">
    <!-- Warehouse Table -->
    <div class="tab-pane fade show active" id="warehouse" role="tabpanel">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <input type="text" id="search-input-warehouse" class="form-control me-2" placeholder="按仓库编号或负责人搜索" style="flex: 1;">
        <button class="btn btn-primary me-2" onclick="searchWarehouse()">查询</button>
        <button class="btn btn-secondary me-2" onclick="showAllWarehouseData()">全部</button>
        <div class="btn-group">
          <button class="btn btn-success d-flex align-items-center" onclick="createWarehouseRow()">
            <i class="bi bi-plus-circle me-2"></i>
            <span style="margin-right: 4px;">添加行</span>
          </button>
          <button class="btn btn-warning d-flex align-items-center text-dark" onclick="updateWarehouseRow()">
            <i class="bi bi-pencil-square me-2"></i>
            <span style="margin-right: 3px;">更新选中行</span>
          </button>
          <button class="btn btn-danger d-flex align-items-center" onclick="deleteWarehouseRows()" style="border-top-right-radius: 5px; border-bottom-right-radius: 5px;">
            <i class="bi bi-trash-fill me-2"></i>
            <span style="margin-right: 2px;">删除选中行</span>
          </button>
        </div>
      </div>
      <div class="table-responsive">
        <table id="warehouse-table" class="table table-striped table-bordered table-hover" style="table-layout: fixed; width: 100%;">
          <thead class="table-dark">
            <tr>
              <th style="width: 12%;">Select</th>
              <th style="width: 16%;">仓库编号</th>
              <th style="width: 18%;">已用库存</th>
              <th style="width: 18%;">库存总量</th>
              <th style="width: 18%;">负责人</th>
              <th style="width: 18%;">电话号码</th>
            </tr>
          </thead>
          <tbody>
            <!-- Data rows -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Suppliers Table -->
    <div class="tab-pane fade" id="supplier" role="tabpanel">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <input type="text" id="search-input-supplier" class="form-control me-2" placeholder="按供应商编号搜索" style="flex: 1;">
        <button class="btn btn-primary me-2" onclick="searchSupplier()">查询</button>
        <button class="btn btn-secondary me-2" onclick="showAllSupplierData()">全部</button>
        <div class="btn-group">
          <button class="btn btn-success d-flex align-items-center" onclick="createSupplierRow()">
            <i class="bi bi-plus-circle me-2"></i>
            <span style="margin-right: 4px;">添加行</span>
          </button>
          <button class="btn btn-warning d-flex align-items-center text-dark" onclick="updateSupplierRow()">
            <i class="bi bi-pencil-square me-2"></i>
            <span style="margin-right: 3px;">更新选中行</span>
          </button>
          <button class="btn btn-danger d-flex align-items-center" onclick="deleteSupplierRows()" style="border-top-right-radius: 5px; border-bottom-right-radius: 5px;">
            <i class="bi bi-trash-fill me-2"></i>
            <span style="margin-right: 2px;">删除选中行</span>
          </button>
        </div>
      </div>
      <div class="table-responsive">
        <table id="supplier-table" class="table table-striped table-bordered table-hover" style="table-layout: fixed; width: 100%;">
          <thead class="table-dark">
            <tr>
              <th style="width: 12%;">Select</th>
              <th style="width: 18%;">供应商编号</th>
              <th style="width: 22%;">供应商名称</th>
              <th style="width: 22%;">联系方式</th>
              <th style="width: 26%;">地址</th>
            </tr>
          </thead>
          <tbody>
            <!-- Data rows -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Parts Procurement Table -->
    <div class="tab-pane fade" id="parts" role="tabpanel">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <input type="text" id="search-input-part" class="form-control me-2" placeholder="按零件编号搜索" style="flex: 1;">
        <button class="btn btn-primary me-2" onclick="searchPart()">查询</button>
        <button class="btn btn-secondary me-2" onclick="showAllPartData()">全部</button>
        <div class="btn-group">
                <button class="btn btn-success d-flex align-items-center" onclick="createPartRow()">
                  <i class="bi bi-plus-circle me-2"></i>
                  <span style="margin-right: 4px;">添加行</span>
                </button>
                <button class="btn btn-warning d-flex align-items-center text-dark" onclick="updatePartRow()">
                  <i class="bi bi-pencil-square me-2"></i>
                  <span style="margin-right: 3px;">更新选中行</span>
                </button>
                <button class="btn btn-danger d-flex align-items-center" onclick="deletePartRows()" style="border-top-right-radius: 5px; border-bottom-right-radius: 5px;">
                  <i class="bi bi-trash-fill me-2"></i>
                  <span style="margin-right: 2px;">删除选中行</span>
                </button>
              </div>
      </div>
      <div class="table-responsive">
        <table id="parts-table" class="table table-striped table-bordered table-hover" style="table-layout: fixed; width: 100%;">
          <thead class="table-dark">
            <tr>
              <th style="width: 12%;">Select</th>
              <th style="width: 18%;">零件编号</th>
              <th style="width: 18%;">采购量</th>
              <th style="width: 16%;">供应商编号</th>
              <th style="width: 18%;">采购时间</th>
              <th style="width: 18%;">采购员</th>
            </tr>
          </thead>
          <tbody>
            <!-- Data rows -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

    </div>
  </section>

  <!-- Contact -->
  <section id="contact">
    <div class="position-relative overflow-hidden px-3 px-md-5 m-md-3 text-center">
      <div class="px-sm-4 px-lg-5 mx-auto mt-2 custom-align mt-4 mb-5">

        <div class="pt-5 text-center">
          <h2>联系我们</h2>
          <p class="lead mx-2 mt-3">欢迎与我们联系，无论是合作提案还是简单问候，我们都乐意为您服务！</p>
          <p>您可以发送邮件至 jg-pams18@gmail.com</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <section>
    <div class="position-relative overflow-hidden px-3 px-md-5 m-md-4 text-center">
      <footer class="d-flex flex-wrap justify-content-between align-items-center py-2 mt-4 border-top">

        <div class="col-md-4 d-flex align-items-left">
          <span class="px-1 mb-3 mb-md-0 text-body-secondary">© 2024 精工零件管理有限公司</span>
        </div>

        <ul class="nav col-md-4 justify-content-end list-unstyled d-flex">
          <li class="ms-3"><a class="text-body-secondary" href="#"><svg class="bi" width="24" height="24">
                <use xlink:href="#twitter"></use>
              </svg></a></li>
          <li class="ms-3"><a class="text-body-secondary" href="#"><svg class="bi" width="24" height="24">
                <use xlink:href="#instagram"></use>
              </svg></a></li>
          <li class="ms-3"><a class="text-body-secondary" href="#"><svg class="bi" width="24" height="24">
                <use xlink:href="#facebook"></use>
              </svg></a></li>
        </ul>

      </footer>
    </div>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

  <script>
    // Role mapping
    const roleMapping = {
      admin: '管理员',
      employee: '售货员',
      purchasing_agent: '采购员',
      suppliers_agent: '联系人'
    };

    // Fetch user info from the server
    fetch('/user-info')
      .then(response => {
        if (!response.ok) {
          throw new Error('Not logged in');
        }
        return response.json();
      })
      .then(user => {
        // Map the role to the translated name
        const translatedRole = roleMapping[user.role] || user.role;

        // Update the dropdown with the user's info
        document.getElementById('user-username').textContent = `已登录 ${user.username}`;
        document.getElementById('user-role').textContent = `身份为${translatedRole}`;
      })
      .catch(error => {
        console.error('Error fetching user info:', error);
        document.getElementById('user-username').textContent = 'Error fetching username.';
        document.getElementById('user-role').textContent = 'Error fetching role.';
      });




    // READ READ READ
    let isAddingPartRow = false;



    // Function to fetch and populate Warehouse data
    async function fetchWarehouseData(endpoint, query = '') {
      const response = await fetch(endpoint + query);
      const data = await response.json();
      populateWarehouseTable(data);
    }

    // Function to populate Warehouse table
    function populateWarehouseTable(data) {
      const tableBody = document.querySelector('#warehouse-table tbody');
      tableBody.innerHTML = '';

      data.forEach(row => {
        const tr = document.createElement('tr');

        const selectTd = document.createElement('td');
        selectTd.innerHTML = '<input type="checkbox" />';
        tr.appendChild(selectTd);

        Object.values(row).forEach(value => {
          const td = document.createElement('td');
          td.textContent = value;
          tr.appendChild(td);
        });

        tableBody.appendChild(tr);
      });
    }

    // Function to fetch and populate Supplier data
    async function fetchSupplierData(endpoint, query = '') {
      const response = await fetch(endpoint + query);
      const data = await response.json();
      populateSupplierTable(data);
    }

    // Function to populate Supplier table
    function populateSupplierTable(data) {
      const tableBody = document.querySelector('#supplier-table tbody');
      tableBody.innerHTML = '';

      data.forEach(row => {
        const tr = document.createElement('tr');

        const selectTd = document.createElement('td');
        selectTd.innerHTML = '<input type="checkbox" />';
        tr.appendChild(selectTd);

        Object.values(row).forEach(value => {
          const td = document.createElement('td');
          td.textContent = value;
          tr.appendChild(td);
        });

        tableBody.appendChild(tr);
      });
    }

    async function fetchPartData(endpoint, query = '') {
      const response = await fetch(endpoint + query);
      const data = await response.json();
      populatePartTable(data);
    }

    function populatePartTable(data) {
      const tableBody = document.querySelector('#parts-table tbody');
      tableBody.innerHTML = '';

      data.forEach(row => {
        const tr = document.createElement('tr');

        const selectTd = document.createElement('td');
        selectTd.innerHTML = '<input type="checkbox" />';
        tr.appendChild(selectTd);

        Object.values(row).forEach(value => {
          const td = document.createElement('td');

          // Check if the value is a date
          if (value && typeof value === 'string' && value.includes('T') && !isNaN(Date.parse(value))) {
            // Convert to local date format (YYYY-MM-DD)
            const localDate = new Date(value);
            const formattedDate = `${localDate.getFullYear()}-${String(localDate.getMonth() + 1).padStart(2, '0')}-${String(localDate.getDate()).padStart(2, '0')}`;
            td.textContent = formattedDate;
          } else {
            td.textContent = value;
          }

          tr.appendChild(td);
        });

        tableBody.appendChild(tr);
      });
    }




    function showWarehouseError(message) {
      alert(message); // Using alert for simplicity; replace with custom UI error display if needed.
    }

    function clearWarehouseError() {
      // If using a custom error display, clear it here.
    }


    function showSupplierError(message) {
      alert(message); // Using alert for simplicity; replace with custom UI error display if needed.
    }

    function clearSupplierError() {
      // If using a custom error display, clear it here.
    }

    function showPartError(message) {
      alert(message); // Using alert for simplicity; replace with custom UI error display if needed.
    }

    function clearPartError() {
      // If using a custom error display, clear it here.
    }





    // ADD ADD ADD
    function createWarehouseRow() {
      const tableBody = document.querySelector('#warehouse-table tbody');
      const btnGroup = document.querySelector('#warehouse .btn-group');
      addRow(tableBody, btnGroup, ['Select', 'WarehouseID', 'UsedStock', 'TotalStock', 'ManagerName', 'PhoneNumber']);
    }

    // Supplier Row Creation
    function createSupplierRow() {
      const tableBody = document.querySelector('#supplier-table tbody');
      const btnGroup = document.querySelector('#supplier .btn-group');
      addRow(tableBody, btnGroup, ['Select', 'SupplierID', 'SupplierName', 'ContactInfo', 'Address']);
    }

    // Parts Procurement Row Creation
    function createPartRow() {
      const tableBody = document.querySelector('#parts-table tbody');
      const btnGroup = document.querySelector('#parts .btn-group');
      addRow(tableBody, btnGroup, ['Select', 'PartID', 'Quantity', 'SupplierID', 'ProcurementDate', 'Purchaser']);
    }

    // Reusable Function to Add Row
    function addRow(tableBody, btnGroup, columnNames) {
      const existingEditableRow = tableBody.querySelector('tr.editing');
      if (existingEditableRow) {
        alert('Please save or cancel the current row before adding a new one.');
        return;
      }

      const tr = document.createElement('tr');
      columnNames.forEach((col, idx) => {
        const td = document.createElement('td');

        if (idx === 0) {
          // Checkbox for the first column
          td.innerHTML = '<input type="checkbox">';
        } else {
          // Create input fields with type-based placeholders
          const input = document.createElement('input');
          input.style.paddingLeft = '8px';
          input.style.paddingBottom = '2px';
          input.style.width = '172px';

          // Infer input type from placeholder context
          input.type = col.toLowerCase().includes('date') ? 'date' : 'text';
          input.placeholder = col;

          td.appendChild(input);
        }

        tr.appendChild(td);
      });

      // Save Button
      const saveButton = document.createElement('button');
      saveButton.innerHTML = 'Save'; // Icon added
      saveButton.className = 'btn btn-success btn-save'; // Green button for Save
      saveButton.style.borderRadius = '5px';
      saveButton.style.padding = '6px 15px';
      saveButton.style.margin = '0 2px'; // Add space to both left and right
      saveButton.style.marginLeft = '9px';  // Left margin
      saveButton.style.display = 'flex';
      saveButton.style.alignItems = 'center';
      saveButton.style.gap = '5px'; // Space between icon and text
      saveButton.onclick = () => saveRow(tr, tableBody);

      // Cancel Button
      const cancelButton = document.createElement('button');
      cancelButton.textContent = 'Cancel';
      cancelButton.className = 'btn btn-secondary btn-cancel';
      cancelButton.style.borderRadius = '5px';  // Same border-radius
      cancelButton.style.padding = '6px 12px';  // Same padding
      cancelButton.style.margin = '0 10px';     // Same margin
      cancelButton.style.marginLeft = '7px';
      cancelButton.style.display = 'flex';      // Same flexbox for alignment
      cancelButton.style.alignItems = 'center'; // Same alignment
      cancelButton.style.gap = '4px';           // Same gap between icon and text
      cancelButton.onclick = () => {
        tr.remove();
        saveButton.remove();
        cancelButton.remove();
      };

      btnGroup.appendChild(saveButton);
      btnGroup.appendChild(cancelButton);
      tableBody.appendChild(tr);
    }

    function saveRow(tr, tableBody) {
      const inputs = Array.from(tr.querySelectorAll('input')).filter(input => input.type !== 'checkbox'); // Ignore checkboxes
      const data = inputs.map(input => input.value.trim());

      // Validate data
      if (data.some(value => !value)) {
        alert('All fields must be filled!');
        return;
      }

      const tableId = tableBody.closest('table').id;
      let endpoint = '';

      // Determine API endpoint based on table ID
      switch (tableId) {
        case 'warehouse-table':
          endpoint = '/create-warehouse';
          break;
        case 'supplier-table':
          endpoint = '/create-supplier';
          break;
        case 'parts-table':
          endpoint = '/create-part';
          break;
        default:
          alert('Unknown table!');
          return;
      }

      const columnNames = Array.from(tr.closest('table').querySelectorAll('thead th')).slice(1); // Exclude "Select" column
      const columnMapping = {
        '仓库编号': 'warehouseId',
        '已用库存': 'usedStock',
        '库存总量': 'totalStock',
        '负责人': 'managerName',
        '电话号码': 'phoneNumber',
        '供应商编号': 'supplierId',
        '供应商名称': 'supplierName',
        '联系方式': 'contactInfo',
        '地址': 'address',
        '零件编号': 'partId',
        '采购量': 'quantity',
        '采购时间': 'procurementDate',
        '采购员': 'purchaser'
      };

      // Map data to JSON object
      const rowData = {};
      columnNames.forEach((col, idx) => {
        const colName = col.textContent.trim();
        const backendKey = columnMapping[colName] || colName; // Map to backend key if available
        rowData[backendKey] = data[idx];
      });
      console.log(rowData);

      // Send data to backend
      fetch(endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(rowData),
      })
        .then(response => {
          if (!response.ok) {
            throw new Error('Failed to save data.');
            console.log("Here!");
          }
          return response.json();
        })
        .then(() => {
          // Assign input values to cell text
          inputs.forEach(input => {
            const td = input.parentElement;
            td.textContent = input.value;
          });

          // Remove Save and Cancel buttons
          const btnGroup = tr.closest('.tab-pane').querySelector('.btn-group');
          btnGroup.querySelector('.btn-save').remove();
          btnGroup.querySelector('.btn-cancel').remove();

          alert('Row saved successfully!');
        })
        .catch(error => {
          console.error(error);
          alert('Error saving row to the database.');
        });
    }





    // UPDATE UPDATE UPDATE
    // Warehouse Row Update
    function updateWarehouseRow() {
      const tableBody = document.querySelector('#warehouse-table tbody');
      const selectedRow = getSelectedRow(tableBody);
      if (!selectedRow) {
        alert('请选择一行更新');
        return;
      }
      const btnGroup = document.querySelector('#warehouse .btn-group');
      editRow(selectedRow, btnGroup, ['WarehouseID', 'UsedStock', 'TotalStock', 'ManagerName', 'PhoneNumber']);
    }

    // Supplier Row Update
    function updateSupplierRow() {
      const tableBody = document.querySelector('#supplier-table tbody');
      const selectedRow = getSelectedRow(tableBody);
      if (!selectedRow) {
        alert('请选择一行更新');
        return;
      }
      const btnGroup = document.querySelector('#supplier .btn-group');
      editRow(selectedRow, btnGroup, ['SupplierID', 'SupplierName', 'ContactInfo', 'Address']);
    }

    // Parts Procurement Row Update
    function updatePartRow() {
      const tableBody = document.querySelector('#parts-table tbody');
      const selectedRow = getSelectedRow(tableBody);
      if (!selectedRow) {
        alert('请选择一行更新');
        return;
      }
      const btnGroup = document.querySelector('#parts .btn-group');
      editRow(selectedRow, btnGroup, ['PartID', 'Quantity', 'SupplierID', 'ProcurementDate', 'Purchaser']);
    }

    // Reusable Function to Edit a Single Row
    function editRow(row, btnGroup, columnNames) {
      const cells = row.querySelectorAll('td');

      // Store the original primary key value in a data attribute
      if (!row.dataset.originalId) {
        row.dataset.originalId = row.cells[1].textContent.trim(); // Assuming column 1 contains the primary key
      }

      cells.forEach((cell, idx) => {
        if (idx === 0) return; // Skip checkbox cell
        const currentValue = cell.textContent.trim();
        cell.innerHTML = `<input type="text" value="${currentValue}" placeholder="${columnNames[idx - 1]}">`;
      });

      const saveButton = document.createElement('button');
      saveButton.innerHTML = 'Save'; // Icon added
      saveButton.className = 'btn btn-success btn-save'; // Green button for Save
      saveButton.style.borderRadius = '5px';
      saveButton.style.padding = '6px 15px';
      saveButton.style.margin = '0 2px'; // Add space to both left and right
      saveButton.style.marginLeft = '9px';  // Left margin
      saveButton.style.display = 'flex';
      saveButton.style.alignItems = 'center';
      saveButton.style.gap = '5px'; // Space between icon and text
      saveButton.onclick = () => saveUpdatedRow(row, btnGroup, columnNames);

      const cancelButton = document.createElement('button');
      cancelButton.textContent = 'Cancel';
      cancelButton.className = 'btn btn-secondary btn-cancel';
      cancelButton.style.borderRadius = '5px';  // Same border-radius
      cancelButton.style.padding = '6px 12px';  // Same padding
      cancelButton.style.margin = '0 10px';     // Same margin
      cancelButton.style.marginLeft = '7px';
      cancelButton.style.display = 'flex';      // Same flexbox for alignment
      cancelButton.style.alignItems = 'center'; // Same alignment
      cancelButton.style.gap = '4px';           // Same gap between icon and text
      cancelButton.onclick = () => {
        cells.forEach((cell, idx) => {
          if (idx === 0) return; // Skip checkbox cell
          const input = cell.querySelector('input');
          if (input) {
            cell.textContent = input.defaultValue; // Revert to original value
          }
        });
        saveButton.remove();
        cancelButton.remove();
      };

      btnGroup.appendChild(saveButton);
      btnGroup.appendChild(cancelButton);
    }

    // Save Updated Row
    function saveUpdatedRow(row, btnGroup, columnNames) {
      const tableId = row.closest('table').id;
      let endpoint = '';
      let uniqueIdKey = ''; // The unique identifier key to send in the payload

      // Determine API endpoint based on table ID
      switch (tableId) {
        case 'warehouse-table':
          endpoint = '/update-warehouse';
          uniqueIdKey = 'originalWarehouseId';
          break;
        case 'supplier-table':
          endpoint = '/update-supplier';
          uniqueIdKey = 'originalSupplierId';
          break;
        case 'parts-table':
          endpoint = '/update-part';
          uniqueIdKey = 'originalPartId';
          break;
        default:
          alert('Unknown table!');
          return;
      }

      // Retrieve the original ID from the row's data attribute
      const uniqueId = row.dataset.originalId;

      const cells = Array.from(row.querySelectorAll('td'));
      const rowData = {};
      rowData[uniqueIdKey] = uniqueId; // Include the original ID in the payload

      const translationMap = {
        '仓库编号': 'warehouseId',
        '已用库存': 'usedStock',
        '库存总量': 'totalStock',
        '负责人': 'managerName',
        '电话号码': 'phoneNumber',
        '供应商编号': 'supplierId',
        '供应商名称': 'supplierName',
        '联系方式': 'contactInfo',
        '地址': 'address',
        '零件编号': 'partId',
        '采购量': 'quantity',
        '采购时间': 'procurementDate',
        '采购员': 'purchaser',
        // Add English equivalents if needed
        'WarehouseID': 'warehouseId',
        'UsedStock': 'usedStock',
        'TotalStock': 'totalStock',
        'ManagerName': 'managerName',
        'PhoneNumber': 'phoneNumber',
        'SupplierID': 'supplierId',
        'SupplierName': 'supplierName',
        'ContactInfo': 'contactInfo',
        'Address': 'address',
        'PartID': 'partId',
        'Quantity': 'quantity',
        'ProcurementDate': 'procurementDate',
        'Purchaser': 'purchaser'
      };

      // Collect updated data and map column names to backend keys in the exact format from translationMap
      columnNames.forEach((colName, idx) => {
        const cell = cells[idx + 1]; // Skip checkbox column
        const input = cell.querySelector('input');
        if (input) {
          // Log the column name being processed
          console.log('Processing Column:', colName);

          // Ensure matching column names from the translation map (case-insensitive)
          const matchingKey = Object.keys(translationMap).find(key =>
            key.trim().toLowerCase() === colName.trim().toLowerCase() // Trim and match case-insensitively
          );

          // If a match is found in the translationMap, use the value from the map
          if (matchingKey) {
            const mappedKey = translationMap[matchingKey]; // Use exact key from translationMap
            rowData[mappedKey] = input.value.trim();
          } else {
            // If no match is found, log and ensure data consistency
            console.log(`No match found for column: ${colName}`);
          }
        }
      });

      // Debugging: Ensure correct data structure
      console.log('Updated Row Data:', rowData);
      console.log(endpoint);

      // Send updated data to backend using PUT
      fetch(endpoint, {
        method: 'PUT', // Use PATCH if partial updates are supported
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(rowData),
      })
        .then(response => {
          if (!response.ok) {
            throw new Error('Failed to update data.');
            console.log("Hello");
          }
          return response.json();
        })
        .then(() => {
          // Finalize row update
          cells.forEach((cell, idx) => {
            if (idx === 0) return; // Skip checkbox cell
            const input = cell.querySelector('input');
            if (input) {
              cell.textContent = input.value; // Update cell with new value
            }
          });

          // Remove Save and Cancel Buttons
          btnGroup.querySelector('.btn-save').remove();
          btnGroup.querySelector('.btn-cancel').remove();

          alert('Row updated successfully!');
        })
        .catch(error => {
          console.error(error);
          alert('Error updating row to the database.');
        });
    }

    // Reusable Function to Get a Single Selected Row
    function getSelectedRow(tableBody) {
      const rows = Array.from(tableBody.querySelectorAll('tr'));
      const selectedRows = rows.filter(row => row.querySelector('input[type="checkbox"]').checked);
      return selectedRows.length === 1 ? selectedRows[0] : null;
    }






    // function createPartRow() {
    //   clearPartError();
    //
    //   if (isAddingPartRow) {
    //     showPartError('Please finish adding the current row before creating a new one.');
    //     return;
    //   }
    //
    //   const tableBody = document.querySelector('#parts-table tbody');
    //   const tr = document.createElement('tr');
    //
    //   tr.innerHTML =
    //     `
    //     <td></td>
    //     <td><input type="text" maxlength="7" placeholder="Part ID (7 chars)" required /></td>
    //     <td><input type="number" min="1" placeholder="Quantity" required /></td>
    //     <td><input type="text" maxlength="3" placeholder="Supplier ID (3 chars)" required /></td>
    //     <td><input type="date" required /></td>
    //     <td><input type="text" maxlength="20" placeholder="Purchaser Name" required /></td>
    //   `;
    //
    //   tableBody.appendChild(tr);
    //   isAddingPartRow = true;
    //
    //   const saveButton = document.createElement('button');
    //   saveButton.textContent = 'Save';
    //   saveButton.classList.add('btn', 'btn-primary', 'me-2');
    //   saveButton.onclick = async () => {
    //     const inputs = tr.querySelectorAll('input');
    //     const data = Array.from(inputs).map(input => input.value.trim());
    //     const partId = data[0];
    //     const supplierId = data[2];
    //
    //     if (data.some(value => !value)) {
    //       showPartError('All fields are required!');
    //       return;
    //     }
    //
    //     if (partId.length !== 7) {
    //       showPartError('Part ID must be exactly 7 characters.');
    //       return;
    //     }
    //
    //     const existingPartIds = Array.from(document.querySelectorAll('#parts-table tbody tr'))
    //       .map(row => row.cells[1]?.textContent?.trim());
    //     if (existingPartIds.includes(partId)) {
    //       showPartError('Duplicate Part ID detected! Please enter a unique Part ID.');
    //       return;
    //     }
    //
    //     if (isNaN(data[1]) || data[1] <= 0) {
    //       showPartError('Quantity must be a valid number.');
    //       return;
    //     }
    //
    //     if (supplierId.length !== 3) {
    //       showPartError('Supplier ID must be exactly 3 characters.');
    //       return;
    //     }
    //
    //     try {
    //       const response = await fetch('/create-part', {
    //         method: 'POST',
    //         headers: {
    //           'Content-Type': 'application/json',
    //         },
    //         body: JSON.stringify({
    //           partId: partId,
    //           quantity: parseInt(data[1], 10),
    //           supplierId: supplierId,
    //           procurementDate: data[3],
    //           purchaser: data[4],
    //         }),
    //       });
    //
    //       if (response.ok) {
    //         clearPartError();
    //         showAllPartData();
    //       } else {
    //         const errorData = await response.json();
    //         showPartError(errorData.error || 'Failed to create row.');
    //       }
    //     } catch (error) {
    //       showPartError('An error occurred. Please try again later.');
    //     } finally {
    //       saveButton.remove();
    //       cancelButton.remove();
    //       isAddingPartRow = false;
    //     }
    //   };
    //
    //   const cancelButton = document.createElement('button');
    //   cancelButton.textContent = 'Cancel';
    //   cancelButton.classList.add('btn', 'btn-secondary');
    //   cancelButton.onclick = () => {
    //     tr.remove();
    //     saveButton.remove();
    //     cancelButton.remove();
    //     isAddingPartRow = false;
    //     clearPartError();
    //   };
    //
    //   const container = document.querySelector('.btn-group');
    //   container.appendChild(saveButton);
    //   container.appendChild(cancelButton);
    // }
    //
    // function updatePartRow() {
    //   clearPartError();
    //   const checkboxes = document.querySelectorAll('#parts-table tbody input[type="checkbox"]:checked');
    //
    //   if (checkboxes.length === 0) {
    //     showPartError('No row selected for update.');
    //     return;
    //   }
    //
    //   if (checkboxes.length > 1) {
    //     showPartError('Only one row can be updated at a time.');
    //     return;
    //   }
    //
    //   const row = checkboxes[0].closest('tr');
    //   const cells = row.querySelectorAll('td');
    //
    //   // Store original values
    //   const originalData = Array.from(cells).map(cell => cell.textContent.trim());
    //
    //   cells.forEach((cell, index) => {
    //     if (index > 0) {
    //       const input = document.createElement('input');
    //       input.type = index === 4 ? 'date' : 'text';
    //       input.value = cell.textContent;
    //       cell.textContent = '';
    //       cell.appendChild(input);
    //
    //       // Add constraints
    //       if (index === 1) input.maxLength = 7; // Part ID
    //       if (index === 2) input.type = 'number'; // Quantity
    //       if (index === 3) input.maxLength = 3; // Supplier ID
    //       if (index === 5) input.maxLength = 20; // Purchaser Name
    //     }
    //   });
    //
    //   const saveButton = document.createElement('button');
    //   saveButton.textContent = 'Save';
    //   saveButton.classList.add('btn', 'btn-primary', 'me-2');
    //   saveButton.onclick = async () => {
    //     const inputs = Array.from(row.querySelectorAll('input')).filter(input => input.type !== 'checkbox');
    //     const data = inputs.map((input, i) => input.value.trim() || originalData[i + 1]);
    //     const partId = data[0];
    //     const supplierId = data[2];
    //
    //     if (!inputs.some((input, i) => input.value.trim() !== originalData[i + 1])) {
    //       showPartError('No changes detected.');
    //       return;
    //     }
    //
    //     if (partId.length !== 7) {
    //       showPartError('Part ID must be exactly 7 characters.');
    //       return;
    //     }
    //
    //     if (isNaN(data[1]) || data[1] <= 0) {
    //       showPartError('Quantity must be a valid number.');
    //       return;
    //     }
    //
    //     if (supplierId.length !== 3) {
    //       showPartError('Supplier ID must be exactly 3 characters.');
    //       return;
    //     }
    //
    //     try {
    //       const response = await fetch('/update-part', {
    //         method: 'PUT',
    //         headers: {
    //           'Content-Type': 'application/json',
    //         },
    //         body: JSON.stringify({
    //           originalPartId: originalData[1], // Send original PartID
    //           partId: data[0],
    //           quantity: parseInt(data[1], 10),
    //           supplierId: supplierId,
    //           procurementDate: new Date(data[3]).toISOString().split('T')[0],
    //           purchaser: data[4],
    //         }),
    //       });
    //
    //       if (response.ok) {
    //         clearPartError();
    //         showAllPartData();
    //       } else {
    //         const errorData = await response.json();
    //         showPartError(errorData.error || 'Failed to update row.');
    //       }
    //     } catch (error) {
    //       showPartError('An error occurred. Please try again later.');
    //     } finally {
    //       saveButton.remove();
    //       cancelButton.remove();
    //     }
    //   };
    //
    //   const cancelButton = document.createElement('button');
    //   cancelButton.textContent = 'Cancel';
    //   cancelButton.classList.add('btn', 'btn-secondary');
    //   cancelButton.onclick = () => {
    //     cells.forEach((cell, index) => {
    //       if (index > 0) cell.textContent = originalData[index];
    //     });
    //     saveButton.remove();
    //     cancelButton.remove();
    //     clearPartError();
    //   };
    //
    //   const container = document.querySelector('.btn-group');
    //   container.appendChild(saveButton);
    //   container.appendChild(cancelButton);
    // }





    // Delete Selected Warehouse Rows
    function deleteWarehouseRows() {
      const checkboxes = document.querySelectorAll('#warehouse-table tbody input[type="checkbox"]:checked');

      if (checkboxes.length === 0) {
        alert('请选择要删除的行。'); // Using alert for simplicity; you can replace this with custom error handling.
        return;
      }

      const ids = Array.from(checkboxes).map(checkbox =>
        checkbox.closest('tr').querySelector('td:nth-child(2)').textContent // Assuming WarehouseID is in the second column
      );

      fetch('/delete-warehouse', {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ ids }),
      })
        .then(response => {
          if (response.ok) {
            showAllWarehouseData(); // Reload data to reflect deletions
          } else {
            alert('无法删除选中的行。'); // Using alert for simplicity
          }
        })
        .catch(() => {
          alert('删除过程中发生错误。');
        });
    }

    // Delete Selected Supplier Rows
    function deleteSupplierRows() {
      const checkboxes = document.querySelectorAll('#supplier-table tbody input[type="checkbox"]:checked');

      if (checkboxes.length === 0) {
        alert('请选择要删除的行。'); // Using alert for simplicity
        return;
      }

      const ids = Array.from(checkboxes).map(checkbox =>
        checkbox.closest('tr').querySelector('td:nth-child(2)').textContent // Assuming SupplierID is in the second column
      );

      fetch('/delete-supplier', {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ ids }),
      })
        .then(response => {
          if (response.ok) {
            showAllSupplierData(); // Reload data to reflect deletions
          } else {
            alert('无法删除选中的行。'); // Using alert for simplicity
          }
        })
        .catch(() => {
          alert('删除过程中发生错误。');
        });
    }

    function deletePartRows() {
      clearPartError();
      const checkboxes = document.querySelectorAll('#parts-table tbody input[type="checkbox"]:checked');

      if (checkboxes.length === 0) {
        showPartError('请选择要删除的行。');
        return;
      }

      const ids = Array.from(checkboxes).map(checkbox =>
        checkbox.closest('tr').querySelector('td:nth-child(2)').textContent
      );

      fetch('/delete-parts', {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ ids }),
        })
        .then(response => {
          if (response.ok) {
            showAllPartData();
          } else {
            showPartError('无法删除选中的行。');
          }
        });
    }





    // Search Warehouse
    function searchWarehouse() {
      const query = document.getElementById('search-input-warehouse').value;
      fetchWarehouseData('/search-warehouse?query=' + encodeURIComponent(query));
    }

    // Show All Warehouse Data
    function showAllWarehouseData() {
      fetchWarehouseData('/warehouse-data');
    }

    // Search Supplier
    function searchSupplier() {
      const query = document.getElementById('search-input-supplier').value;
      fetchSupplierData('/search-supplier?query=' + encodeURIComponent(query));
    }

    // Show All Supplier Data
    function showAllSupplierData() {
      fetchSupplierData('/supplier-data');
    }

    function searchPart() {
      const query = document.getElementById('search-input-part').value;
      fetchPartData('/search-part?query=' + encodeURIComponent(query));
    }

    function showAllPartData() {
      fetchPartData('/parts-data');
    }




    window.onload = () => {
      showAllPartData();
      showAllWarehouseData();
      showAllSupplierData();
    };

  </script>

</body>

</html>
